<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anonymous Opinions</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="mode-toggle" onclick="toggleDarkMode()">ðŸŒ™</div> <!-- Dark mode toggle button -->
    <div id="notification" class="notification">
        <p id="notificationMessage"></p>
    </div>

    <div class="floating-nav">
        <button class="fab-btn" id="fabBtn" aria-label="Open menu">+</button>
        <div class="nav-options">
            <button class="nav-option" id="termsBtn" aria-label="Terms and Conditions">ðŸ“œ Terms</button>
            <button class="nav-option" id="contactBtn" aria-label="Contact Information">ðŸ“ž Contact</button>
            <button class="nav-option" id="communityBtn" aria-label="Community Guidelines">ðŸ“š Guidelines</button>
        </div>
        <div class="overlay hidden" id="overlay">
            <div class="content-container">
                <button class="close-btn" id="closeBtn" aria-label="Close">Ã—</button>
                <div id="termsContent" class="content">
                    <h3>Terms & Conditions</h3>
                    <p>Welcome to our platform! By using our service, you agree to the following terms...</p>
                </div>
                <div id="contactContent" class="content hidden">
                    <h3>Contact Info</h3>
                    <p><strong>Email:</strong> name86473@gmail.com</p>
                    <p><strong>Phone:</strong> +1 123-456-7890</p>
                </div>
                <div id="communityContent" class="content hidden">
                    <h3>Community Guidelines</h3>
                    <ul>
                        <li><strong>Respect Others:</strong> Be kind and respectful.</li>
                        <li><strong>Constructive Feedback:</strong> Engage thoughtfully.</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <h1>Share Your Opinion Anonymously</h1>

        <!-- Profile Section -->
        <div class="profile-section">
            <img id="avatar" src="default-avatar.png" alt="Avatar" />
            <input type="file" id="avatarUpload" accept="image/*" onchange="updateAvatar()" />
            <textarea id="description" placeholder="Write a short bio..." oninput="updateDescription()"></textarea>
        </div>

        <!-- Post & Poll Creation -->
        <div class="form-container">
            <textarea id="postText" placeholder="Whatâ€™s on your mind?" rows="4"></textarea>
            <button id="submitBtn">Post Opinion</button>
            <!-- Poll Form -->
            <div id="pollForm" class="poll-form">
                <input type="text" id="pollQuestion" placeholder="Enter poll question" />
                <input type="text" id="pollOption1" placeholder="Option 1" />
                <input type="text" id="pollOption2" placeholder="Option 2" />
                <button onclick="createPoll()">Create Poll</button>
            </div>
        </div>

        <!-- Post Feed -->
        <div id="posts" class="posts-feed"></div>

        <footer>
            <p>Powered by Ably & MongoDB Atlas</p>
        </footer>
    </div>

    <script src="https://cdn.ably.io/lib/ably.min.js"></script>
    <script>
        const ably = new Ably.Realtime('z-PJnQ.-j8d2A:2MPSxeZ_Vfj487pTV11np4OE5yDTAZiln1a5IXWNj34');
        const channel = ably.channels.get('opinions');

        let reputation = parseInt(localStorage.getItem('reputation')) || 0;
        const username = localStorage.getItem('username') || generateUsername();
        const sessionId = sessionStorage.getItem('sessionId') || generateSessionId();

        // Display initial reputation and username
        document.getElementById('reputation').innerText = `Reputation: ${reputation}`;
        localStorage.setItem('username', username); // Store username

        // Handle post submission
        document.getElementById('submitBtn').addEventListener('click', postOpinion);

        // Handle poll creation
        function createPoll() {
            const question = document.getElementById('pollQuestion').value.trim();
            const option1 = document.getElementById('pollOption1').value.trim();
            const option2 = document.getElementById('pollOption2').value.trim();

            if (question && option1 && option2) {
                const pollData = {
                    username,
                    question,
                    options: [option1, option2],
                    votes: [0, 0],
                    sessionId,
                };

                channel.publish('newPoll', pollData);
                showNotification('Poll created successfully!', false);
                document.getElementById('pollForm').reset();
            } else {
                showNotification('Please fill out all fields for the poll.', true);
            }
        }

        // Handle post submission
        async function postOpinion() {
            const postText = document.getElementById('postText').value.trim();
            const submitBtn = document.getElementById('submitBtn');

            if (postText) {
                submitBtn.classList.add('button-clicked');
                try {
                    const postData = { message: postText, username, sessionId };
                    const response = await fetch('/api/postOpinion', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(postData),
                    });

                    if (response.ok) {
                        const newPost = await response.json();
                        addPostToFeed(newPost);
                        increaseReputation(10); // Increase reputation for posting
                    }
                } catch (error) {
                    console.error('Error posting opinion:', error);
                    showNotification('Error submitting post: ' + error.message, true);
                } finally {
                    setTimeout(() => submitBtn.classList.remove('button-clicked'), 200);
                }
            }
        }

        // Handle comments and increase reputation for commenting
        function addComment(postId, commentText) {
            const commentData = { postId, username, commentText, sessionId };
            channel.publish('newComment', commentData);
            increaseReputation(5); // Increase reputation for commenting
        }

        // Increase reputation by specified amount
        function increaseReputation(points) {
            reputation += points;
            localStorage.setItem('reputation', reputation);
            document.getElementById('reputation').innerText = `Reputation: ${reputation}`;
        }

        // Update profile avatar
        function updateAvatar() {
            const avatarFile = document.getElementById('avatarUpload').files[0];
            if (avatarFile) {
                const reader = new FileReader();
                reader.onloadend = () => {
                    document.getElementById('avatar').src = reader.result;
                    localStorage.setItem('avatar', reader.result); // Save avatar to localStorage
                };
                reader.readAsDataURL(avatarFile);
            }
        }

        // Update profile description
        function updateDescription() {
            const description = document.getElementById('description').value;
            localStorage.setItem('description', description); // Save description to localStorage
        }

        // Fetch posts and comments from backend (real-time updates will be done via Ably)
        window.onload = async () => {
            try {
                const posts = await fetchPosts();
                posts.forEach(post => addPostToFeed(post));
            } catch (error) {
                console.error("Error loading posts: ", error);
            }
        };

        // Fetch posts from the backend
        async function fetchPosts() {
            try {
                const response = await fetch('/api/posts');
                if (!response.ok) throw new Error('Failed to load posts');
                return await response.json();
            } catch (error) {
                console.error('Error fetching posts:', error);
                return [];
            }
        }

        // Add a post to the feed
        function addPostToFeed(post) {
            const postFeed = document.getElementById('posts');
            const postCard = document.createElement('div');
            postCard.className = 'post-card';
            postCard.setAttribute('data-id', post._id);

            postCard.innerHTML = `
                <p><strong>${post.username}</strong>: ${post.message}</p>
                <p class="timestamp">${new Date(post.timestamp).toLocaleString()}</p>
                <button onclick="addComment('${post._id}', prompt('Add a comment:'))">Add Comment</button>
                <div id="comments-${post._id}">
                    ${post.comments.map(comment => `<p>${comment.username}: ${comment.message}</p>`).join('')}
                </div>
            `;

            postFeed.appendChild(postCard);
        }

        // Handle real-time updates
        channel.subscribe('newOpinion', function (message) {
            addPostToFeed(message.data);
        });

        channel.subscribe('newComment', function (message) {
            const postCard = document.querySelector(`[data-id='${message.data.postId}']`);
            const commentsDiv = postCard.querySelector(`#comments-${message.data.postId}`);
            commentsDiv.innerHTML += `<p><strong>${message.data.username}</strong>: ${message.data.commentText}</p>`;
        });

        // Generate a unique session ID
        function generateSessionId() {
            return Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
        }

        // Generate a unique 4-word username
        function generateUsername() {
            const words = ["Sun", "Moon", "Star", "Sky", "Ocean", "Forest", "Mountain", "Cloud", "River", "Desert", "Lake", "Earth"];
            const randomWords = [];
            for (let i = 0; i < 4; i++) {
                const randomIndex = Math.floor(Math.random() * words.length);
                randomWords.push(words[randomIndex]);
            }
            return randomWords.join("");
        }
    </script>
</body>
</html>







